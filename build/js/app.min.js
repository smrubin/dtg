function FreeSegment(t,e){this.type="FreeSegment",this.a=t,this.b=e,this.noon={a:t,b:e},this.three={a:{x:-t.y,y:t.x},b:{x:-e.y,y:e.x}},this.six={a:{x:-t.x,y:-t.y},b:{x:-e.x,y:-e.y}},this.nine={a:{x:t.y,y:-t.x},b:{x:e.y,y:-e.x}}}function FixedSegment(t,e){this.type="FixedSegment",this.a=t,this.b=e,this.noon={a:t,b:e},this.three={a:t,b:e},this.six={a:t,b:e},this.nine={a:t,b:e}}function PivotSegment(t,e){this.type="FreeSegment",this.a=t,this.b=e;var n=e.x-t.x,i=e.y-t.y;this.delta={x:n,y:i},this.noon={a:t,b:e},this.three={a:{x:-t.y,y:t.x},b:{x:-t.y+n,y:t.x+i}},this.six={a:{x:-t.x,y:-t.y},b:{x:-t.x+n,y:-t.y+i}},this.nine={a:{x:t.y,y:-t.x},b:{x:t.y+n,y:-t.x+i}}}function RotateSegment(t,e){this.type="RotateSegment",this.a=t,this.b=e;var n=e.x-t.x,i=e.y-t.y;this.delta={x:n,y:i},this.theta=Math.atan2(i,n),this.noon={a:t,b:e},this.three={a:t,b:this.getB(TAU/4)},this.six={a:t,b:this.getB(TAU/2)},this.nine={a:t,b:this.getB(3*TAU/4)}}function FlyWheel(t){this.angle=0,this.friction=.95,this.velocity=0;for(var e in t)this[e]=t[e]}function Maze(){this.freeSegments=[],this.fixedSegments=[],this.pivotSegments=[],this.rotateSegments=[],this.flyWheel=new FlyWheel({friction:.8}),this.connections={}}function getFrontMatter(t){if(t){var e={};return t.split("\n").forEach(function(t){if(t){var n=t.split(":"),i=n[0].trim(),o=n[1].trim();"true"===o?o=!0:"false"===o?o=!1:o.match(/$\d+(\.\d+)?^/)?o=parseFloat(o,10):o.match(/$\d+\.\d+^/)&&(o=parseFloat(o)),e[i]=o}}),e}}function getHorizSegment(t,e,n){var i={x:t+1,y:e},o={x:t-1,y:e};return new n(i,o)}function getVertSegment(t,e,n){var i={x:t,y:e+1},o={x:t,y:e-1};return new n(i,o)}function fillCircle(t,e,n,i){t.beginPath(),t.arc(e,n,i,0,2*Math.PI),t.fill(),t.closePath()}function strokeCircle(t,e,n,i){t.beginPath(),t.arc(e,n,i,0,2*Math.PI),t.stroke(),t.closePath()}function renderGoal(t,e,n,i,o,r){t.save(),t.translate(e,n),t.rotate(-i);var a=Math.PI/2,s=r,c=Math.cos(a)*s-25,l=Math.sin(a)*s-40;t.drawImage(dumpImg,c,l),t.restore()}function WinAnimation(t,e){this.x=t,this.y=e,this.startTime=new Date,this.isPlaying=!0}function renderStar(t){t.lineWidth=8,t.lineJoin="round",t.lineCap="round",t.fillStyle="hsla(50, 100%, 50%, 1)",t.strokeStyle="hsla(50, 100%, 50%, 1)",t.beginPath();for(var e=0;11>e;e++){var n=2*Math.PI*e/10+Math.PI/2,i=e%2?20:10,o=Math.cos(n)*i,r=Math.sin(n)*i;t[e?"lineTo":"moveTo"](o,r)}t.fill(),t.stroke(),t.closePath()}function getParent(t,e){for(var n=t;n!=document.body;){if(n.matches(e))return n;n=n.parentNode}}function loadLevel(t){var e=levelsElem.querySelector("#"+t);if(maze=new Maze,maze.id=t,!e)return void console.error("pre not found for "+t);maze.loadText(e.textContent),levelList.classList.remove("is-open"),nextLevelButton.classList.remove("is-open"),window.scrollTo(0,0);var n=levelList.querySelector(".is-playing");n&&n.classList.remove("is-playing"),levelList.querySelector('[data-id="'+t+'"]').classList.add("is-playing"),localStorage.setItem("currentLevel",t)}function getIsInsideCub(t){var e=getCanvasMazePosition(t),n=Math.abs(e.x-cub[maze.orientation].x*gridSize),i=Math.abs(e.y-cub[maze.orientation].y*gridSize),o=1.5*gridSize;return o>=n&&o>=i}function getCanvasMazePosition(t){var e=t.pageX-canvasLeft,n=t.pageY-canvasTop;return{x:e-mazeCenter.x,y:n-mazeCenter.y}}function getDragAngle(t){var e=getCanvasMazePosition(t);return normalizeAngle(Math.atan2(e.y,e.x))}function animate(){update(),render(),requestAnimationFrame(animate)}function update(){dragCub(),dragAngle?maze.flyWheel.setAngle(dragAngle):maze.attractAlignFlyWheel(),maze.update(),winAnim&&winAnim.update()}function dragCub(){if(cubDragMove){var t=getCubConnections(),e={x:dragStartPegPosition.x+cubDragMove.x,y:dragStartPegPosition.y+cubDragMove.y},n=getDragPeg(t,e);cub.setPeg(n,maze.orientation);var i=getDragPosition(t,e),o=getCubPosition(),r={x:i.x-o.x,y:i.y-o.y};cub.setOffset(r,maze.orientation)}}function getCubPosition(){return{x:cub[maze.orientation].x*gridSize+mazeCenter.x,y:cub[maze.orientation].y*gridSize+mazeCenter.y}}function getCubConnections(){var t=cub[maze.orientation].x,e=cub[maze.orientation].y,n=maze.orientation+":"+t+","+e;return maze.connections[n]}function getDragPosition(t,e){if(1==t.length)return getSegmentDragPosition(t[0],e);var n=t.map(function(t){var n=getSegmentDragPosition(t,e);return{position:n,distance:getDistance(e,n)}});return n.sort(distanceSorter),n[0].position}function getSegmentDragPosition(t,e){var n,i,o=t[maze.orientation],r=o.a.y==o.b.y;return r?(n=getSegmentDragCoord(o,"x",e),i=o.a.y*gridSize+mazeCenter.y):(n=o.a.x*gridSize+mazeCenter.x,i=getSegmentDragCoord(o,"y",e)),{x:n,y:i}}function getSegmentDragCoord(t,e,n){var i=t.a[e],o=t.b[e],r=o>i?i:o,a=i>o?i:o;return r=r*gridSize+mazeCenter[e],a=a*gridSize+mazeCenter[e],Math.max(r,Math.min(a,n[e]))}function distanceSorter(t,e){return t.distance-e.distance}function getDragPeg(t,e){var n=[];t.forEach(function(t){var e=t[maze.orientation];addPegPoint(e.a,n),addPegPoint(e.b,n)});var i=n.map(function(t){var n=t.split(","),i={x:parseInt(n[0],10),y:parseInt(n[1],10)},o={x:i.x*gridSize+mazeCenter.x,y:i.y*gridSize+mazeCenter.y};return{peg:i,distance:getDistance(e,o)}});return i.sort(distanceSorter),i[0].peg}function getDistance(t,e){var n=e.x-t.x,i=e.y-t.y;return Math.sqrt(n*n+i*i)}function addPegPoint(t,e){var n=t.x+","+t.y;-1==e.indexOf(n)&&e.push(n)}function onHoverMousemove(t){var e=getIsInsideCub(t);if(e!=isCubHovered){isCubHovered=e;var n=e?"add":"remove";docElem.classList[n]("is-cub-hovered")}}function render(){ctx.clearRect(0,0,canvasWidth,canvasHeight),ctx.save(),ctx.scale(2,2),renderRotateHandle(),maze.render(ctx,mazeCenter,gridSize,maze.flyWheel.angle),winAnim&&winAnim.render(ctx);var t=isCubHovered||isCubDragging;cub.render(ctx,mazeCenter,gridSize,maze.flyWheel.angle,t,img),ctx.restore()}function renderRotateHandle(){if(rotatePointer){ctx.lineCap="round",ctx.lineJoin="round",ctx.lineWidth=.5*gridSize;var t="#EEE";ctx.strokeStyle=t,ctx.fillStyle=t,ctx.beginPath();var e=maze.gridMax*gridSize;ctx.moveTo(mazeCenter.x,mazeCenter.y);var n=normalizeAngle(normalizeAngle(moveAngle)-normalizeAngle(dragStartAngle))>TAU/2;ctx.arc(mazeCenter.x,mazeCenter.y,e,dragStartAngle,moveAngle,n),ctx.lineTo(mazeCenter.x,mazeCenter.y),ctx.stroke(),ctx.fill(),ctx.closePath()}}function completeLevel(){var t=getCubPosition();winAnim=new WinAnimation(t.x,t.y),levelList.querySelector('[data-id="'+maze.id+'"]').classList.add("did-complete"),-1==completedLevels.indexOf(maze.id)&&(completedLevels.push(maze.id),localStorage.setItem("completedLevels",completedLevels.join(","))),getNextLevel()&&setTimeout(function(){nextLevelButton.classList.add("is-open")},1e3)}function getNextLevel(){var t=levels.indexOf(maze.id);return levels[t+1]}function normalizeAngle(t){return(t%TAU+TAU)%TAU}!function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof module&&module.exports?module.exports=e():t.EvEmitter=e()}(this,function(){"use strict";function t(){}var e=t.prototype;return e.on=function(t,e){if(t&&e){var n=this._events=this._events||{},i=n[t]=n[t]||[];return-1==i.indexOf(e)&&i.push(e),this}},e.once=function(t,e){if(t&&e){this.on(t,e);var n=this._onceEvents=this._onceEvents||{},i=n[t]=n[t]||{};return i[e]=!0,this}},e.off=function(t,e){var n=this._events&&this._events[t];if(n&&n.length){var i=n.indexOf(e);return-1!=i&&n.splice(i,1),this}},e.emitEvent=function(t,e){var n=this._events&&this._events[t];if(n&&n.length){var i=0,o=n[i];e=e||[];for(var r=this._onceEvents&&this._onceEvents[t];o;){var a=r&&r[o];a&&(this.off(t,o),delete r[o]),o.apply(this,e),i+=a?0:1,o=n[i]}return this}},t}),function(t,e){"function"==typeof define&&define.amd?define(["ev-emitter/ev-emitter"],function(n){return e(t,n)}):"object"==typeof module&&module.exports?module.exports=e(t,require("ev-emitter")):t.Unipointer=e(t,t.EvEmitter)}(window,function(t,e){"use strict";function n(){}function i(){}var o=i.prototype=Object.create(e.prototype);o.bindStartEvent=function(t){this._bindStartEvent(t,!0)},o.unbindStartEvent=function(t){this._bindStartEvent(t,!1)},o._bindStartEvent=function(e,n){n=void 0===n?!0:!!n;var i=n?"addEventListener":"removeEventListener";t.navigator.pointerEnabled?e[i]("pointerdown",this):t.navigator.msPointerEnabled?e[i]("MSPointerDown",this):(e[i]("mousedown",this),e[i]("touchstart",this))},o.handleEvent=function(t){var e="on"+t.type;this[e]&&this[e](t)},o.getTouch=function(t){for(var e=0;e<t.length;e++){var n=t[e];if(n.identifier==this.pointerIdentifier)return n}},o.onmousedown=function(t){var e=t.button;e&&0!==e&&1!==e||this._pointerDown(t,t)},o.ontouchstart=function(t){this._pointerDown(t,t.changedTouches[0])},o.onMSPointerDown=o.onpointerdown=function(t){this._pointerDown(t,t)},o._pointerDown=function(t,e){this.isPointerDown||(this.isPointerDown=!0,this.pointerIdentifier=void 0!==e.pointerId?e.pointerId:e.identifier,this.pointerDown(t,e))},o.pointerDown=function(t,e){this._bindPostStartEvents(t),this.emitEvent("pointerDown",[t,e])};var r={mousedown:["mousemove","mouseup"],touchstart:["touchmove","touchend","touchcancel"],pointerdown:["pointermove","pointerup","pointercancel"],MSPointerDown:["MSPointerMove","MSPointerUp","MSPointerCancel"]};return o._bindPostStartEvents=function(e){if(e){var n=r[e.type];n.forEach(function(e){t.addEventListener(e,this)},this),this._boundPointerEvents=n}},o._unbindPostStartEvents=function(){this._boundPointerEvents&&(this._boundPointerEvents.forEach(function(e){t.removeEventListener(e,this)},this),delete this._boundPointerEvents)},o.onmousemove=function(t){this._pointerMove(t,t)},o.onMSPointerMove=o.onpointermove=function(t){t.pointerId==this.pointerIdentifier&&this._pointerMove(t,t)},o.ontouchmove=function(t){var e=this.getTouch(t.changedTouches);e&&this._pointerMove(t,e)},o._pointerMove=function(t,e){this.pointerMove(t,e)},o.pointerMove=function(t,e){this.emitEvent("pointerMove",[t,e])},o.onmouseup=function(t){this._pointerUp(t,t)},o.onMSPointerUp=o.onpointerup=function(t){t.pointerId==this.pointerIdentifier&&this._pointerUp(t,t)},o.ontouchend=function(t){var e=this.getTouch(t.changedTouches);e&&this._pointerUp(t,e)},o._pointerUp=function(t,e){this._pointerDone(),this.pointerUp(t,e)},o.pointerUp=function(t,e){this.emitEvent("pointerUp",[t,e])},o._pointerDone=function(){this.isPointerDown=!1,delete this.pointerIdentifier,this._unbindPostStartEvents(),this.pointerDone()},o.pointerDone=n,o.onMSPointerCancel=o.onpointercancel=function(t){t.pointerId==this.pointerIdentifier&&this._pointerCancel(t,t)},o.ontouchcancel=function(t){var e=this.getTouch(t.changedTouches);e&&this._pointerCancel(t,e)},o._pointerCancel=function(t,e){this._pointerDone(),this.pointerCancel(t,e)},o.pointerCancel=function(t,e){this.emitEvent("pointerCancel",[t,e])},i.getPointerPoint=function(t){return{x:t.pageX,y:t.pageY}},i});var proto=FreeSegment.prototype;proto.render=function(t,e,n){var i=this.a.x*n,o=this.a.y*n,r=this.b.x*n,a=this.b.y*n;t.strokeStyle="hsla(204, 70%, 53%, 0.7)",t.lineWidth=.6*n,t.lineCap="round",t.beginPath(),t.moveTo(i,o),t.lineTo(r,a),t.stroke(),t.closePath()};var proto=FixedSegment.prototype;proto.render=function(t,e,n){var i=this.a.x*n,o=this.a.y*n,r=this.b.x*n,a=this.b.y*n;t.strokeStyle="hsla(210, 29%, 24%, 0.6)",t.lineWidth=.8*n,t.lineCap="round",t.beginPath(),t.moveTo(i,o),t.lineTo(r,a),t.stroke(),t.closePath()};var proto=PivotSegment.prototype;proto.render=function(t,e,n,i){var o=this.a.x*n,r=this.a.y*n,a=this.delta.x*n,s=this.delta.y*n;t.save(),t.translate(o,r),t.rotate(-i);var c="hsla(150, 100%, 35%, 0.7)";t.strokeStyle=c,t.lineWidth=.4*n,t.lineCap="round",t.beginPath(),t.moveTo(0,0),t.lineTo(a,s),t.stroke(),t.closePath(),t.fillStyle=c,t.beginPath(),t.arc(0,0,.4*n,0,2*Math.PI),t.fill(),t.closePath(),t.restore()};var TAU=2*Math.PI,proto=RotateSegment.prototype;proto.getB=function(t){return{x:Math.round(this.a.x+2*Math.cos(this.theta+t)),y:Math.round(this.a.y+2*Math.sin(this.theta+t))}},proto.render=function(t,e,n,i){var o=this.a.x*n,r=this.a.y*n;t.save(),t.translate(o,r),t.rotate(i);var a="hsla(6, 78%, 57%, 0.6)";t.strokeStyle=a,t.fillStyle=a,t.lineWidth=.8*n,t.lineJoin="round",t.rotate(TAU/8),t.strokeRect(.2*-n,.2*-n,.4*n,.4*n),t.rotate(-TAU/8),t.lineWidth=.8*n,t.lineCap="round",t.beginPath(),t.moveTo(0,0);var s=this.delta.x*n,c=this.delta.y*n;t.lineTo(s,c),t.stroke(),t.closePath(),t.restore()};var TAU=2*Math.PI,proto=FlyWheel.prototype;proto.integrate=function(){this.velocity*=this.friction,this.angle+=this.velocity,this.normalizeAngle()},proto.applyForce=function(t){this.velocity+=t},proto.normalizeAngle=function(){this.angle=(this.angle%TAU+TAU)%TAU},proto.setAngle=function(t){var e=t-this.angle;e>TAU/2?e-=TAU:-TAU/2>e&&(e+=TAU);var n=e-this.velocity;this.applyForce(n)};var cub={offset:{x:0,y:0}},pegOrienter={noon:function(t){return t},three:function(t){return{x:t.y,y:-t.x}},six:function(t){return{x:-t.x,y:-t.y}},nine:function(t){return{x:-t.y,y:t.x}}};cub.setPeg=function(t,e){t=pegOrienter[e](t),this.peg=t,this.noon={x:t.x,y:t.y},this.three={x:-t.y,y:t.x},this.six={x:-t.x,y:-t.y},this.nine={x:t.y,y:-t.x}};var offsetOrienter={noon:function(t){return t},three:function(t){return{x:t.y,y:-t.x}},six:function(t){return{x:-t.x,y:-t.y}},nine:function(t){return{x:-t.y,y:t.x}}};cub.setOffset=function(t,e){this.offset=offsetOrienter[e](t)},cub.render=function(t,e,n,i,o,r){var a=this.peg.x*n+this.offset.x,s=this.peg.y*n+this.offset.y;t.save(),t.translate(e.x,e.y),t.rotate(i),t.translate(a,s),t.rotate(-i);var c=o?1.15:1;t.scale(c,c),t.drawImage(r,-23,-25),t.restore()};var proto=Maze.prototype;proto.loadText=function(t){var e=t.split("---\n"),n={};e.length>1&&(n=getFrontMatter(e[0]));for(var i=e[e.length-1],o=i.split("\n"),r=this.gridCount=o[0].length,a=this.gridMax=(r-1)/2,s=0;s<o.length;s++)for(var c=o[s],l=c.split(""),h=0;h<l.length;h++){var u=l[h],g=h-a,d=s-a,p="parse"+u;this[p]&&this[p](g,d)}},proto["parse-"]=proto.addFreeHorizSegment=function(t,e){var n=getHorizSegment(t,e,FreeSegment);this.connectSegment(n),this.freeSegments.push(n)},proto["parse|"]=proto.addFreeVertSegment=function(t,e){var n=getVertSegment(t,e,FreeSegment);this.connectSegment(n),this.freeSegments.push(n)},proto["parse="]=proto.addFixedHorizSegment=function(t,e){var n=getHorizSegment(t,e,FixedSegment);this.connectSegment(n),this.fixedSegments.push(n)},proto["parse!"]=proto.addFixedVertSegment=function(t,e){var n=getVertSegment(t,e,FixedSegment);this.connectSegment(n),this.fixedSegments.push(n)},proto["parse^"]=proto.addPivotUpSegment=function(t,e){var n={x:t,y:e+1},i={x:t,y:e-1},o=new PivotSegment(n,i);this.connectSegment(o),this.pivotSegments.push(o)},proto.parsev=proto.addPivotDownSegment=function(t,e){var n={x:t,y:e-1},i={x:t,y:e+1},o=new PivotSegment(n,i);this.connectSegment(o),this.pivotSegments.push(o)},proto["parse<"]=proto.addPivotLeftSegment=function(t,e){var n={x:t+1,y:e},i={x:t-1,y:e},o=new PivotSegment(n,i);this.connectSegment(o),this.pivotSegments.push(o)},proto["parse>"]=proto.addPivotRightSegment=function(t,e){var n={x:t-1,y:e},i={x:t+1,y:e},o=new PivotSegment(n,i);this.connectSegment(o),this.pivotSegments.push(o)},proto.parse8=proto.addRotateUpSegment=function(t,e){var n={x:t,y:e+1},i={x:t,y:e-1},o=new RotateSegment(n,i);this.connectSegment(o),this.rotateSegments.push(o)},proto.parse4=proto.addRotateLeftSegment=function(t,e){var n={x:t+1,y:e},i={x:t-1,y:e},o=new RotateSegment(n,i);this.connectSegment(o),this.rotateSegments.push(o)},proto.parse5=proto.addRotateUpSegment=function(t,e){var n={x:t,y:e-1},i={x:t,y:e+1},o=new RotateSegment(n,i);this.connectSegment(o),this.rotateSegments.push(o)},proto.parse6=proto.addRotateRightSegment=function(t,e){var n={x:t-1,y:e},i={x:t+1,y:e},o=new RotateSegment(n,i);this.connectSegment(o),this.rotateSegments.push(o)},proto["parse#"]=function(t,e){this.addFreeHorizSegment(t,e),this.addFixedHorizSegment(t,e)},proto.parse$=function(t,e){this.addFreeVertSegment(t,e),this.addFixedVertSegment(t,e)},proto.parseI=function(t,e){this.addPivotUpSegment(t,e),this.addFixedVertSegment(t,e)},proto.parseJ=function(t,e){this.addPivotLeftSegment(t,e),this.addFixedHorizSegment(t,e)},proto.parseK=function(t,e){this.addPivotDownSegment(t,e),this.addFixedVertSegment(t,e)},proto.parseL=function(t,e){this.addPivotRightSegment(t,e),this.addFixedHorizSegment(t,e)},proto.parseW=function(t,e){this.addPivotUpSegment(t,e),this.addFreeVertSegment(t,e)},proto.parseA=function(t,e){this.addPivotLeftSegment(t,e),this.addFreeHorizSegment(t,e)},proto.parseS=function(t,e){this.addPivotDownSegment(t,e),this.addFreeVertSegment(t,e)},proto.parseD=function(t,e){this.addPivotRightSegment(t,e),this.addFreeHorizSegment(t,e)},proto["parse@"]=function(t,e){this.startPosition={x:t,y:e},cub.setPeg(this.startPosition,"noon")},proto["parse*"]=function(t,e){this.goalPosition={x:t,y:e}},proto.updateItemGroups=function(){var t={};this.items.forEach(function(e){void 0===t[e.type]&&(t[e.type]=[]),t[e.type].push(e)}),this.itemGroups=t};var orientations=["noon","three","six","nine"];proto.connectSegment=function(t){orientations.forEach(function(e){var n=t[e];this.getIsPegOut(n.a)||this.getIsPegOut(n.b)||(this.connectPeg(t,e,n.a),this.connectPeg(t,e,n.b))},this)},proto.getIsPegOut=function(t){return Math.abs(t.x)>this.gridMax||Math.abs(t.y)>this.gridMax},proto.connectPeg=function(t,e,n){var i=e+":"+n.x+","+n.y,o=this.connections[i];o||(o=this.connections[i]=[]),-1==o.indexOf(t)&&o.push(t)},proto.update=function(){this.flyWheel.integrate();var t=this.flyWheel.angle;TAU/8>t?this.orientation="noon":3*TAU/8>t?this.orientation="three":5*TAU/8>t?this.orientation="six":7*TAU/8>t?this.orientation="nine":this.orientation="noon"},proto.attractAlignFlyWheel=function(){var t,e=this.flyWheel.angle;t=TAU/8>e?0:3*TAU/8>e?TAU/4:5*TAU/8>e?TAU/2:7*TAU/8>e?3*TAU/4:TAU;var n=.03*(t-e);this.flyWheel.applyForce(n)};var TAU=2*Math.PI,orientationAngles={noon:0,three:TAU/4,six:TAU/2,nine:3*TAU/4};proto.render=function(t,e,n,i){var o=orientationAngles[i],r=this.gridMax;i=void 0!==o?o:i||0,t.save(),t.translate(e.x,e.y),this.fixedSegments.forEach(function(i){i.render(t,e,n)}),this.rotateSegments.forEach(function(o){o.render(t,e,n,i)}),t.rotate(i),t.lineWidth=.2*n,t.lineCap="round",t.lineJoin="round",t.lineWidth=.2*n,t.strokeStyle="hsla(0, 0%, 50%, 0.2)",t.save(),t.rotate(Math.PI/4),t.strokeRect(-n/5,-n/5,2*n/5,2*n/5),t.restore(),t.strokeStyle="hsla(330, 100%, 50%, 0.3)",t.lineWidth=.15*n;var a=this.startPosition.x*n,s=this.startPosition.y*n;strokeCircle(t,a,s,.5*n);for(var c=-r;r>=c;c+=2)for(var l=-r;r>=l;l+=2){var h=l*n,u=c*n;t.fillStyle="hsla(0, 0%, 50%, 0.6)",fillCircle(t,h,u,.15*n)}this.freeSegments.forEach(function(i){i.render(t,e,n)}),this.pivotSegments.forEach(function(o){o.render(t,e,n,i)});var g=this.goalPosition.x*n,d=this.goalPosition.y*n;t.lineWidth=.3*n,t.fillStyle="hsla(50, 100%, 50%, 1)",t.strokeStyle="hsla(50, 100%, 50%, 1)",renderGoal(t,g,d,i,.6*n,.3*n),t.restore()};var duration=1500,proto=WinAnimation.prototype;proto.update=function(){this.isPlaying&&(this.t=(new Date-this.startTime)/duration,this.isPlaying=this.t<=1)},proto.render=function(t){this.isPlaying&&(t.save(),t.translate(this.x,this.y),this.renderBurst(t),t.save(),t.scale(.5,-.5),this.renderBurst(t),t.restore(),t.restore())},proto.renderBurst=function(t){for(var e=this.t,n=1-e,i=1-n*n*n*n*n*n*n*n,o=-100*i,r=(2-2*this.t,1.5*(1-e*e*e)),a=1*Math.PI*e*e*e,s=0;5>s;s++)t.save(),t.rotate(2*Math.PI/5*s),t.translate(0,o),t.scale(r,r),t.rotate(a),t.drawImage(hatLargeImg,0,0),t.restore()};var docElem=document.documentElement,canvas=document.querySelector("canvas"),ctx=canvas.getContext("2d"),img=new Image;img.src="./img/trump-cartoon.png";var hatLargeImg=new Image;hatLargeImg.src="./img/trump-hat-l.png";var hatSmallImg=new Image;hatSmallImg.src="./img/trump-hat-s.png";var dumpImg=new Image;dumpImg.src="./img/dump.png";var canvasSize=Math.min(window.innerWidth,window.innerHeight),canvasWidth=canvas.width=2*window.innerWidth,canvasHeight=canvas.height=2*window.innerHeight-2*canvas.offsetTop,maze,PI=Math.PI,TAU=2*PI,dragAngle=null,cubDragMove=null,isCubHovered=!1,isCubDragging=!1,winAnim,unipointer=new Unipointer,gridSize=Math.min(40,canvasSize/12),mazeCenter={x:canvasWidth/4,y:Math.min(8*gridSize,canvasHeight/4)},instructionsList=document.querySelector(".instructions-list");instructionsList.addEventListener("click",function(t){t.stopPropagation()});var levelList=document.querySelector(".level-list"),levelsElem=document.querySelector(".levels"),levels=[];!function(){for(var t=levelsElem.querySelectorAll("pre"),e=document.createDocumentFragment(),n=0;n<t.length;n++){var i=t[n],o=document.createElement("li");o.className="level-list__item";var r=i.id;o.innerHTML='<span class="level-list__item__number">'+(n+1)+'</span> <span class="level-list__item__blurb">'+i.getAttribute("data-blurb")+'</span><span class="level-list__item__check">✔</span>',o.setAttribute("data-id",r),e.appendChild(o),levels.push(r)}levelList.appendChild(e),levelList.addEventListener("click",function(t){t.stopPropagation()});var a=document.createElement("i");a.className="fa fa-times close-button",levelList.appendChild(a)}();var instructionsButton=document.querySelector(".instructions-button");instructionsButton.addEventListener("click",function(t){t.stopPropagation(),instructionsList.classList.add("is-open"),levelList.classList.remove("is-open")});for(var closeButton=document.querySelectorAll(".close-button"),i=0;i<closeButton.length;i++)closeButton[i].addEventListener("click",function(){this.parentElement.classList.remove("is-open")});document.addEventListener("click",function(){instructionsList.classList.contains("is-open")?instructionsList.classList.remove("is-open"):levelList.classList.contains("is-open")&&levelList.classList.remove("is-open")});var levelSelectButton=document.querySelector(".level-select-button"),nextLevelButton=document.querySelector(".next-level-button");if(levelSelectButton.addEventListener("click",function(t){t.stopPropagation(),levelList.classList.add("is-open"),instructionsList.classList.remove("is-open")}),nextLevelButton.style.top=canvas.offsetTop+"px",levelList.addEventListener("click",function(t){var e=getParent(t.target,".level-list__item");if(e){var n=e.getAttribute("data-id");loadLevel(n)}}),"object"==typeof localStorage)try{localStorage.setItem("localStorage",1),localStorage.removeItem("localStorage")}catch(e){Storage.prototype._setItem=Storage.prototype.setItem,Storage.prototype.setItem=function(){},alert('Your web browser does not support storing settings locally. In Safari, the most common cause of this is using "Private Browsing Mode". Some settings may not save or some features may not work properly for you.')}var initialLevel=localStorage.getItem("currentLevel")||levels[0];loadLevel(initialLevel),unipointer.bindStartEvent(canvas),window.addEventListener("mousemove",onHoverMousemove),animate();var canvasLeft=canvas.offsetLeft,canvasTop=canvas.offsetTop,pointerBehavior,cubDrag={},mazeRotate={};unipointer.pointerDown=function(t,e){t.preventDefault();var n=getIsInsideCub(e);pointerBehavior=n?cubDrag:mazeRotate,pointerBehavior.pointerDown(t,e),this._bindPostStartEvents(t)},unipointer.pointerMove=function(t,e){pointerBehavior.pointerMove(t,e)},unipointer.pointerUp=function(t,e){pointerBehavior.pointerUp(t,e),this._unbindPostStartEvents()};var dragStartPosition,dragStartPegPosition,rotatePointer;cubDrag.pointerDown=function(t,e){var n=getCubConnections();n&&n.length&&(isCubDragging=!0,dragStartPosition={x:e.pageX,y:e.pageY},dragStartPegPosition={x:cub[maze.orientation].x*gridSize+mazeCenter.x,y:cub[maze.orientation].y*gridSize+mazeCenter.y},docElem.classList.add("is-cub-dragging"))},cubDrag.pointerMove=function(t,e){isCubDragging&&(cubDragMove={x:e.pageX-dragStartPosition.x,y:e.pageY-dragStartPosition.y})},cubDrag.pointerUp=function(){cubDragMove=null,docElem.classList.remove("is-cub-dragging"),isCubDragging=!1,cub.setOffset({x:0,y:0},maze.orientation),cub.peg.x==maze.goalPosition.x&&cub.peg.y==maze.goalPosition.y&&(completeLevel(),console.log("win"))};var dragStartAngle,dragStartMazeAngle,moveAngle,mazeRotate={};mazeRotate.pointerDown=function(t,e){dragStartAngle=moveAngle=getDragAngle(e),dragStartMazeAngle=maze.flyWheel.angle,dragAngle=dragStartMazeAngle,rotatePointer=e},mazeRotate.pointerMove=function(t,e){rotatePointer=e,moveAngle=getDragAngle(e);var n=moveAngle-dragStartAngle;dragAngle=normalizeAngle(dragStartMazeAngle+n)},mazeRotate.pointerUp=function(){dragAngle=null,rotatePointer=null};var completedLevels=localStorage.getItem("completedLevels");completedLevels=completedLevels?completedLevels.split(","):[],completedLevels.forEach(function(t){var e=levelList.querySelector('[data-id="'+t+'"]');e&&e.classList.add("did-complete")}),nextLevelButton.addEventListener("click",function(){var t=getNextLevel();t&&loadLevel(t)});