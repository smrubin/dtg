function FreeSegment(e,t){this.type="FreeSegment",this.a=e,this.b=t,this.noon={a:e,b:t},this.three={a:{x:-e.y,y:e.x},b:{x:-t.y,y:t.x}},this.six={a:{x:-e.x,y:-e.y},b:{x:-t.x,y:-t.y}},this.nine={a:{x:e.y,y:-e.x},b:{x:t.y,y:-t.x}}}function FixedSegment(e,t){this.type="FixedSegment",this.a=e,this.b=t,this.noon={a:e,b:t},this.three={a:e,b:t},this.six={a:e,b:t},this.nine={a:e,b:t}}function PivotSegment(e,t){this.type="FreeSegment",this.a=e,this.b=t;var n=t.x-e.x,i=t.y-e.y;this.delta={x:n,y:i},this.noon={a:e,b:t},this.three={a:{x:-e.y,y:e.x},b:{x:-e.y+n,y:e.x+i}},this.six={a:{x:-e.x,y:-e.y},b:{x:-e.x+n,y:-e.y+i}},this.nine={a:{x:e.y,y:-e.x},b:{x:e.y+n,y:-e.x+i}}}function RotateSegment(e,t){this.type="RotateSegment",this.a=e,this.b=t;var n=t.x-e.x,i=t.y-e.y;this.delta={x:n,y:i},this.theta=Math.atan2(i,n),this.noon={a:e,b:t},this.three={a:e,b:this.getB(TAU/4)},this.six={a:e,b:this.getB(TAU/2)},this.nine={a:e,b:this.getB(3*TAU/4)}}function FlyWheel(e){this.angle=0,this.friction=.95,this.velocity=0;for(var t in e)this[t]=e[t]}function Maze(){this.freeSegments=[],this.fixedSegments=[],this.pivotSegments=[],this.rotateSegments=[],this.flyWheel=new FlyWheel({friction:.8}),this.connections={}}function getFrontMatter(e){if(e){var t={};return e.split("\n").forEach(function(e){if(e){var n=e.split(":"),i=n[0].trim(),o=n[1].trim();"true"===o?o=!0:"false"===o?o=!1:o.match(/$\d+(\.\d+)?^/)?o=parseFloat(o,10):o.match(/$\d+\.\d+^/)&&(o=parseFloat(o)),t[i]=o}}),t}}function getHorizSegment(e,t,n){var i={x:e+1,y:t},o={x:e-1,y:t};return new n(i,o)}function getVertSegment(e,t,n){var i={x:e,y:t+1},o={x:e,y:t-1};return new n(i,o)}function fillCircle(e,t,n,i){e.beginPath(),e.arc(t,n,i,0,2*Math.PI),e.fill(),e.closePath()}function strokeCircle(e,t,n,i){e.beginPath(),e.arc(t,n,i,0,2*Math.PI),e.stroke(),e.closePath()}function renderGoal(e,t,n,i,o,r){e.save(),e.translate(t,n),e.rotate(-i);var a=Math.PI/2,s=r,c=Math.cos(a)*s-25,l=Math.sin(a)*s-40;e.drawImage(dumpImg,c,l),e.restore()}function WinAnimation(e,t){this.x=e,this.y=t,this.startTime=new Date,this.isPlaying=!0}function renderStar(e){e.lineWidth=8,e.lineJoin="round",e.lineCap="round",e.fillStyle="hsla(50, 100%, 50%, 1)",e.strokeStyle="hsla(50, 100%, 50%, 1)",e.beginPath();for(var t=0;11>t;t++){var n=2*Math.PI*t/10+Math.PI/2,i=t%2?20:10,o=Math.cos(n)*i,r=Math.sin(n)*i;e[t?"lineTo":"moveTo"](o,r)}e.fill(),e.stroke(),e.closePath()}function getParent(e,t){for(var n=e;n!=document.body;){if(n.matches(t))return n;n=n.parentNode}}function loadLevel(e){var t=levelsElem.querySelector("#"+e);if(maze=new Maze,maze.id=e,!t)return void console.error("pre not found for "+e);maze.loadText(t.textContent),levelList.classList.remove("is-open"),nextLevelButton.classList.remove("is-open"),window.scrollTo(0,0);var n=levelList.querySelector(".is-playing");n&&n.classList.remove("is-playing"),levelList.querySelector('[data-id="'+e+'"]').classList.add("is-playing"),localStorage.setItem("currentLevel",e)}function getIsInsideCub(e){var t=getCanvasMazePosition(e),n=Math.abs(t.x-cub[maze.orientation].x*gridSize),i=Math.abs(t.y-cub[maze.orientation].y*gridSize),o=1.5*gridSize;return o>=n&&o>=i}function getCanvasMazePosition(e){var t=e.pageX-canvasLeft,n=e.pageY-canvasTop;return{x:t-mazeCenter.x,y:n-mazeCenter.y}}function getDragAngle(e){var t=getCanvasMazePosition(e);return normalizeAngle(Math.atan2(t.y,t.x))}function animate(){update(),render(),requestAnimationFrame(animate)}function update(){dragCub(),dragAngle?maze.flyWheel.setAngle(dragAngle):maze.attractAlignFlyWheel(),maze.update(),winAnim&&winAnim.update()}function dragCub(){if(cubDragMove){var e=getCubConnections(),t={x:dragStartPegPosition.x+cubDragMove.x,y:dragStartPegPosition.y+cubDragMove.y},n=getDragPeg(e,t);cub.setPeg(n,maze.orientation);var i=getDragPosition(e,t),o=getCubPosition(),r={x:i.x-o.x,y:i.y-o.y};cub.setOffset(r,maze.orientation)}}function getCubPosition(){return{x:cub[maze.orientation].x*gridSize+mazeCenter.x,y:cub[maze.orientation].y*gridSize+mazeCenter.y}}function getCubConnections(){var e=cub[maze.orientation].x,t=cub[maze.orientation].y,n=maze.orientation+":"+e+","+t;return maze.connections[n]}function getDragPosition(e,t){if(1==e.length)return getSegmentDragPosition(e[0],t);var n=e.map(function(e){var n=getSegmentDragPosition(e,t);return{position:n,distance:getDistance(t,n)}});return n.sort(distanceSorter),n[0].position}function getSegmentDragPosition(e,t){var n,i,o=e[maze.orientation],r=o.a.y==o.b.y;return r?(n=getSegmentDragCoord(o,"x",t),i=o.a.y*gridSize+mazeCenter.y):(n=o.a.x*gridSize+mazeCenter.x,i=getSegmentDragCoord(o,"y",t)),{x:n,y:i}}function getSegmentDragCoord(e,t,n){var i=e.a[t],o=e.b[t],r=o>i?i:o,a=i>o?i:o;return r=r*gridSize+mazeCenter[t],a=a*gridSize+mazeCenter[t],Math.max(r,Math.min(a,n[t]))}function distanceSorter(e,t){return e.distance-t.distance}function getDragPeg(e,t){var n=[];e.forEach(function(e){var t=e[maze.orientation];addPegPoint(t.a,n),addPegPoint(t.b,n)});var i=n.map(function(e){var n=e.split(","),i={x:parseInt(n[0],10),y:parseInt(n[1],10)},o={x:i.x*gridSize+mazeCenter.x,y:i.y*gridSize+mazeCenter.y};return{peg:i,distance:getDistance(t,o)}});return i.sort(distanceSorter),i[0].peg}function getDistance(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)}function addPegPoint(e,t){var n=e.x+","+e.y;-1==t.indexOf(n)&&t.push(n)}function onHoverMousemove(e){var t=getIsInsideCub(e);if(t!=isCubHovered){isCubHovered=t;var n=t?"add":"remove";docElem.classList[n]("is-cub-hovered")}}function render(){ctx.clearRect(0,0,canvasWidth,canvasHeight),ctx.save(),ctx.scale(2,2),renderRotateHandle(),maze.render(ctx,mazeCenter,gridSize,maze.flyWheel.angle),winAnim&&winAnim.render(ctx);var e=isCubHovered||isCubDragging;cub.render(ctx,mazeCenter,gridSize,maze.flyWheel.angle,e,img),ctx.restore()}function renderRotateHandle(){if(rotatePointer){ctx.lineCap="round",ctx.lineJoin="round",ctx.lineWidth=.5*gridSize;var e="#EEE";ctx.strokeStyle=e,ctx.fillStyle=e,ctx.beginPath();var t=maze.gridMax*gridSize;ctx.moveTo(mazeCenter.x,mazeCenter.y);var n=normalizeAngle(normalizeAngle(moveAngle)-normalizeAngle(dragStartAngle))>TAU/2;ctx.arc(mazeCenter.x,mazeCenter.y,t,dragStartAngle,moveAngle,n),ctx.lineTo(mazeCenter.x,mazeCenter.y),ctx.stroke(),ctx.fill(),ctx.closePath()}}function completeLevel(){var e=getCubPosition();winAnim=new WinAnimation(e.x,e.y),levelList.querySelector('[data-id="'+maze.id+'"]').classList.add("did-complete"),-1==completedLevels.indexOf(maze.id)&&(completedLevels.push(maze.id),localStorage.setItem("completedLevels",completedLevels.join(","))),getNextLevel()&&setTimeout(function(){nextLevelButton.classList.add("is-open")},1e3)}function getNextLevel(){var e=levels.indexOf(maze.id);return levels[e+1]}function normalizeAngle(e){return(e%TAU+TAU)%TAU}!function(e,t){"function"==typeof define&&define.amd?define(t):"object"==typeof module&&module.exports?module.exports=t():e.EvEmitter=t()}(this,function(){"use strict";function e(){}var t=e.prototype;return t.on=function(e,t){if(e&&t){var n=this._events=this._events||{},i=n[e]=n[e]||[];return-1==i.indexOf(t)&&i.push(t),this}},t.once=function(e,t){if(e&&t){this.on(e,t);var n=this._onceEvents=this._onceEvents||{},i=n[e]=n[e]||{};return i[t]=!0,this}},t.off=function(e,t){var n=this._events&&this._events[e];if(n&&n.length){var i=n.indexOf(t);return-1!=i&&n.splice(i,1),this}},t.emitEvent=function(e,t){var n=this._events&&this._events[e];if(n&&n.length){var i=0,o=n[i];t=t||[];for(var r=this._onceEvents&&this._onceEvents[e];o;){var a=r&&r[o];a&&(this.off(e,o),delete r[o]),o.apply(this,t),i+=a?0:1,o=n[i]}return this}},e}),function(e,t){"function"==typeof define&&define.amd?define(["ev-emitter/ev-emitter"],function(n){return t(e,n)}):"object"==typeof module&&module.exports?module.exports=t(e,require("ev-emitter")):e.Unipointer=t(e,e.EvEmitter)}(window,function(e,t){"use strict";function n(){}function i(){}var o=i.prototype=Object.create(t.prototype);o.bindStartEvent=function(e){this._bindStartEvent(e,!0)},o.unbindStartEvent=function(e){this._bindStartEvent(e,!1)},o._bindStartEvent=function(t,n){n=void 0===n?!0:!!n;var i=n?"addEventListener":"removeEventListener";e.navigator.pointerEnabled?t[i]("pointerdown",this):e.navigator.msPointerEnabled?t[i]("MSPointerDown",this):(t[i]("mousedown",this),t[i]("touchstart",this))},o.handleEvent=function(e){var t="on"+e.type;this[t]&&this[t](e)},o.getTouch=function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.identifier==this.pointerIdentifier)return n}},o.onmousedown=function(e){var t=e.button;t&&0!==t&&1!==t||this._pointerDown(e,e)},o.ontouchstart=function(e){this._pointerDown(e,e.changedTouches[0])},o.onMSPointerDown=o.onpointerdown=function(e){this._pointerDown(e,e)},o._pointerDown=function(e,t){this.isPointerDown||(this.isPointerDown=!0,this.pointerIdentifier=void 0!==t.pointerId?t.pointerId:t.identifier,this.pointerDown(e,t))},o.pointerDown=function(e,t){this._bindPostStartEvents(e),this.emitEvent("pointerDown",[e,t])};var r={mousedown:["mousemove","mouseup"],touchstart:["touchmove","touchend","touchcancel"],pointerdown:["pointermove","pointerup","pointercancel"],MSPointerDown:["MSPointerMove","MSPointerUp","MSPointerCancel"]};return o._bindPostStartEvents=function(t){if(t){var n=r[t.type];n.forEach(function(t){e.addEventListener(t,this)},this),this._boundPointerEvents=n}},o._unbindPostStartEvents=function(){this._boundPointerEvents&&(this._boundPointerEvents.forEach(function(t){e.removeEventListener(t,this)},this),delete this._boundPointerEvents)},o.onmousemove=function(e){this._pointerMove(e,e)},o.onMSPointerMove=o.onpointermove=function(e){e.pointerId==this.pointerIdentifier&&this._pointerMove(e,e)},o.ontouchmove=function(e){var t=this.getTouch(e.changedTouches);t&&this._pointerMove(e,t)},o._pointerMove=function(e,t){this.pointerMove(e,t)},o.pointerMove=function(e,t){this.emitEvent("pointerMove",[e,t])},o.onmouseup=function(e){this._pointerUp(e,e)},o.onMSPointerUp=o.onpointerup=function(e){e.pointerId==this.pointerIdentifier&&this._pointerUp(e,e)},o.ontouchend=function(e){var t=this.getTouch(e.changedTouches);t&&this._pointerUp(e,t)},o._pointerUp=function(e,t){this._pointerDone(),this.pointerUp(e,t)},o.pointerUp=function(e,t){this.emitEvent("pointerUp",[e,t])},o._pointerDone=function(){this.isPointerDown=!1,delete this.pointerIdentifier,this._unbindPostStartEvents(),this.pointerDone()},o.pointerDone=n,o.onMSPointerCancel=o.onpointercancel=function(e){e.pointerId==this.pointerIdentifier&&this._pointerCancel(e,e)},o.ontouchcancel=function(e){var t=this.getTouch(e.changedTouches);t&&this._pointerCancel(e,t)},o._pointerCancel=function(e,t){this._pointerDone(),this.pointerCancel(e,t)},o.pointerCancel=function(e,t){this.emitEvent("pointerCancel",[e,t])},i.getPointerPoint=function(e){return{x:e.pageX,y:e.pageY}},i});var proto=FreeSegment.prototype;proto.render=function(e,t,n){var i=this.a.x*n,o=this.a.y*n,r=this.b.x*n,a=this.b.y*n;e.strokeStyle="hsla(200, 80%, 50%, 0.7)",e.lineWidth=.6*n,e.lineCap="round",e.beginPath(),e.moveTo(i,o),e.lineTo(r,a),e.stroke(),e.closePath()};var proto=FixedSegment.prototype;proto.render=function(e,t,n){var i=this.a.x*n,o=this.a.y*n,r=this.b.x*n,a=this.b.y*n;e.strokeStyle="hsla(282, 80%, 63%, 0.6)",e.lineWidth=.8*n,e.lineCap="round",e.beginPath(),e.moveTo(i,o),e.lineTo(r,a),e.stroke(),e.closePath()};var proto=PivotSegment.prototype;proto.render=function(e,t,n,i){var o=this.a.x*n,r=this.a.y*n,a=this.delta.x*n,s=this.delta.y*n;e.save(),e.translate(o,r),e.rotate(-i);var c="hsla(150, 100%, 35%, 0.7)";e.strokeStyle=c,e.lineWidth=.4*n,e.lineCap="round",e.beginPath(),e.moveTo(0,0),e.lineTo(a,s),e.stroke(),e.closePath(),e.fillStyle=c,e.beginPath(),e.arc(0,0,.4*n,0,2*Math.PI),e.fill(),e.closePath(),e.restore()};var TAU=2*Math.PI,proto=RotateSegment.prototype;proto.getB=function(e){return{x:Math.round(this.a.x+2*Math.cos(this.theta+e)),y:Math.round(this.a.y+2*Math.sin(this.theta+e))}},proto.render=function(e,t,n,i){var o=this.a.x*n,r=this.a.y*n;e.save(),e.translate(o,r),e.rotate(i);var a="hsla(0, 100%, 50%, 0.6)";e.strokeStyle=a,e.fillStyle=a,e.lineWidth=.8*n,e.lineJoin="round",e.rotate(TAU/8),e.strokeRect(.2*-n,.2*-n,.4*n,.4*n),e.rotate(-TAU/8),e.lineWidth=.8*n,e.lineCap="round",e.beginPath(),e.moveTo(0,0);var s=this.delta.x*n,c=this.delta.y*n;e.lineTo(s,c),e.stroke(),e.closePath(),e.restore()};var TAU=2*Math.PI,proto=FlyWheel.prototype;proto.integrate=function(){this.velocity*=this.friction,this.angle+=this.velocity,this.normalizeAngle()},proto.applyForce=function(e){this.velocity+=e},proto.normalizeAngle=function(){this.angle=(this.angle%TAU+TAU)%TAU},proto.setAngle=function(e){var t=e-this.angle;t>TAU/2?t-=TAU:-TAU/2>t&&(t+=TAU);var n=t-this.velocity;this.applyForce(n)};var cub={offset:{x:0,y:0}},pegOrienter={noon:function(e){return e},three:function(e){return{x:e.y,y:-e.x}},six:function(e){return{x:-e.x,y:-e.y}},nine:function(e){return{x:-e.y,y:e.x}}};cub.setPeg=function(e,t){e=pegOrienter[t](e),this.peg=e,this.noon={x:e.x,y:e.y},this.three={x:-e.y,y:e.x},this.six={x:-e.x,y:-e.y},this.nine={x:e.y,y:-e.x}};var offsetOrienter={noon:function(e){return e},three:function(e){return{x:e.y,y:-e.x}},six:function(e){return{x:-e.x,y:-e.y}},nine:function(e){return{x:-e.y,y:e.x}}};cub.setOffset=function(e,t){this.offset=offsetOrienter[t](e)},cub.render=function(e,t,n,i,o,r){var a=this.peg.x*n+this.offset.x,s=this.peg.y*n+this.offset.y;e.save(),e.translate(t.x,t.y),e.rotate(i),e.translate(a,s),e.rotate(-i);var c=o?1.15:1;e.scale(c,c),e.drawImage(r,-23,-25),e.restore()};var proto=Maze.prototype;proto.loadText=function(e){var t=e.split("---\n"),n={};t.length>1&&(n=getFrontMatter(t[0]));for(var i=t[t.length-1],o=i.split("\n"),r=this.gridCount=o[0].length,a=this.gridMax=(r-1)/2,s=0;s<o.length;s++)for(var c=o[s],l=c.split(""),h=0;h<l.length;h++){var u=l[h],g=h-a,d=s-a,v="parse"+u;this[v]&&this[v](g,d)}},proto["parse-"]=proto.addFreeHorizSegment=function(e,t){var n=getHorizSegment(e,t,FreeSegment);this.connectSegment(n),this.freeSegments.push(n)},proto["parse|"]=proto.addFreeVertSegment=function(e,t){var n=getVertSegment(e,t,FreeSegment);this.connectSegment(n),this.freeSegments.push(n)},proto["parse="]=proto.addFixedHorizSegment=function(e,t){var n=getHorizSegment(e,t,FixedSegment);this.connectSegment(n),this.fixedSegments.push(n)},proto["parse!"]=proto.addFixedVertSegment=function(e,t){var n=getVertSegment(e,t,FixedSegment);this.connectSegment(n),this.fixedSegments.push(n)},proto["parse^"]=proto.addPivotUpSegment=function(e,t){var n={x:e,y:t+1},i={x:e,y:t-1},o=new PivotSegment(n,i);this.connectSegment(o),this.pivotSegments.push(o)},proto.parsev=proto.addPivotDownSegment=function(e,t){var n={x:e,y:t-1},i={x:e,y:t+1},o=new PivotSegment(n,i);this.connectSegment(o),this.pivotSegments.push(o)},proto["parse<"]=proto.addPivotLeftSegment=function(e,t){var n={x:e+1,y:t},i={x:e-1,y:t},o=new PivotSegment(n,i);this.connectSegment(o),this.pivotSegments.push(o)},proto["parse>"]=proto.addPivotRightSegment=function(e,t){var n={x:e-1,y:t},i={x:e+1,y:t},o=new PivotSegment(n,i);this.connectSegment(o),this.pivotSegments.push(o)},proto.parse8=proto.addRotateUpSegment=function(e,t){var n={x:e,y:t+1},i={x:e,y:t-1},o=new RotateSegment(n,i);this.connectSegment(o),this.rotateSegments.push(o)},proto.parse4=proto.addRotateLeftSegment=function(e,t){var n={x:e+1,y:t},i={x:e-1,y:t},o=new RotateSegment(n,i);this.connectSegment(o),this.rotateSegments.push(o)},proto.parse5=proto.addRotateUpSegment=function(e,t){var n={x:e,y:t-1},i={x:e,y:t+1},o=new RotateSegment(n,i);this.connectSegment(o),this.rotateSegments.push(o)},proto.parse6=proto.addRotateRightSegment=function(e,t){var n={x:e-1,y:t},i={x:e+1,y:t},o=new RotateSegment(n,i);this.connectSegment(o),this.rotateSegments.push(o)},proto["parse#"]=function(e,t){this.addFreeHorizSegment(e,t),this.addFixedHorizSegment(e,t)},proto.parse$=function(e,t){this.addFreeVertSegment(e,t),this.addFixedVertSegment(e,t)},proto.parseI=function(e,t){this.addPivotUpSegment(e,t),this.addFixedVertSegment(e,t)},proto.parseJ=function(e,t){this.addPivotLeftSegment(e,t),this.addFixedHorizSegment(e,t)},proto.parseK=function(e,t){this.addPivotDownSegment(e,t),this.addFixedVertSegment(e,t)},proto.parseL=function(e,t){this.addPivotRightSegment(e,t),this.addFixedHorizSegment(e,t)},proto.parseW=function(e,t){this.addPivotUpSegment(e,t),this.addFreeVertSegment(e,t)},proto.parseA=function(e,t){this.addPivotLeftSegment(e,t),this.addFreeHorizSegment(e,t)},proto.parseS=function(e,t){this.addPivotDownSegment(e,t),this.addFreeVertSegment(e,t)},proto.parseD=function(e,t){this.addPivotRightSegment(e,t),this.addFreeHorizSegment(e,t)},proto["parse@"]=function(e,t){this.startPosition={x:e,y:t},cub.setPeg(this.startPosition,"noon")},proto["parse*"]=function(e,t){this.goalPosition={x:e,y:t}},proto.updateItemGroups=function(){var e={};this.items.forEach(function(t){void 0===e[t.type]&&(e[t.type]=[]),e[t.type].push(t)}),this.itemGroups=e};var orientations=["noon","three","six","nine"];proto.connectSegment=function(e){orientations.forEach(function(t){var n=e[t];this.getIsPegOut(n.a)||this.getIsPegOut(n.b)||(this.connectPeg(e,t,n.a),this.connectPeg(e,t,n.b))},this)},proto.getIsPegOut=function(e){return Math.abs(e.x)>this.gridMax||Math.abs(e.y)>this.gridMax},proto.connectPeg=function(e,t,n){var i=t+":"+n.x+","+n.y,o=this.connections[i];o||(o=this.connections[i]=[]),-1==o.indexOf(e)&&o.push(e)},proto.update=function(){this.flyWheel.integrate();var e=this.flyWheel.angle;TAU/8>e?this.orientation="noon":3*TAU/8>e?this.orientation="three":5*TAU/8>e?this.orientation="six":7*TAU/8>e?this.orientation="nine":this.orientation="noon"},proto.attractAlignFlyWheel=function(){var e,t=this.flyWheel.angle;e=TAU/8>t?0:3*TAU/8>t?TAU/4:5*TAU/8>t?TAU/2:7*TAU/8>t?3*TAU/4:TAU;var n=.03*(e-t);this.flyWheel.applyForce(n)};var TAU=2*Math.PI,orientationAngles={noon:0,three:TAU/4,six:TAU/2,nine:3*TAU/4};proto.render=function(e,t,n,i){var o=orientationAngles[i],r=this.gridMax;i=void 0!==o?o:i||0,e.save(),e.translate(t.x,t.y),this.fixedSegments.forEach(function(i){i.render(e,t,n)}),this.rotateSegments.forEach(function(o){o.render(e,t,n,i)}),e.rotate(i),e.lineWidth=.2*n,e.lineCap="round",e.lineJoin="round",e.lineWidth=.2*n,e.strokeStyle="hsla(0, 0%, 50%, 0.2)",e.save(),e.rotate(Math.PI/4),e.strokeRect(-n/5,-n/5,2*n/5,2*n/5),e.restore(),e.strokeStyle="hsla(330, 100%, 50%, 0.3)",e.lineWidth=.15*n;var a=this.startPosition.x*n,s=this.startPosition.y*n;strokeCircle(e,a,s,.5*n);for(var c=-r;r>=c;c+=2)for(var l=-r;r>=l;l+=2){var h=l*n,u=c*n;e.fillStyle="hsla(0, 0%, 50%, 0.6)",fillCircle(e,h,u,.15*n)}this.freeSegments.forEach(function(i){i.render(e,t,n)}),this.pivotSegments.forEach(function(o){o.render(e,t,n,i)});var g=this.goalPosition.x*n,d=this.goalPosition.y*n;e.lineWidth=.3*n,e.fillStyle="hsla(50, 100%, 50%, 1)",e.strokeStyle="hsla(50, 100%, 50%, 1)",renderGoal(e,g,d,i,.6*n,.3*n),e.restore()};var duration=1500,proto=WinAnimation.prototype;proto.update=function(){this.isPlaying&&(this.t=(new Date-this.startTime)/duration,this.isPlaying=this.t<=1)},proto.render=function(e){this.isPlaying&&(e.save(),e.translate(this.x,this.y),this.renderBurst(e),e.save(),e.scale(.5,-.5),this.renderBurst(e),e.restore(),e.restore())},proto.renderBurst=function(e){for(var t=this.t,n=1-t,i=1-n*n*n*n*n*n*n*n,o=-100*i,r=(2-2*this.t,1.5*(1-t*t*t)),a=1*Math.PI*t*t*t,s=0;5>s;s++)e.save(),e.rotate(2*Math.PI/5*s),e.translate(0,o),e.scale(r,r),e.rotate(a),e.drawImage(hatLargeImg,0,0),e.restore()};var docElem=document.documentElement,canvas=document.querySelector("canvas"),ctx=canvas.getContext("2d"),img=new Image;img.src="./img/trump-cartoon.png";var hatLargeImg=new Image;hatLargeImg.src="./img/trump-hat-l.png";var hatSmallImg=new Image;hatSmallImg.src="./img/trump-hat-s.png";var dumpImg=new Image;dumpImg.src="./img/dump.png";var canvasSize=Math.min(window.innerWidth,window.innerHeight),canvasWidth=canvas.width=2*window.innerWidth,canvasHeight=canvas.height=2*window.innerHeight-2*canvas.offsetTop,maze,PI=Math.PI,TAU=2*PI,dragAngle=null,cubDragMove=null,isCubHovered=!1,isCubDragging=!1,winAnim,unipointer=new Unipointer,gridSize=Math.min(40,canvasSize/12),mazeCenter={x:canvasWidth/4,y:Math.min(8*gridSize,canvasHeight/4)},instructionsList=document.querySelector(".instructions-list");instructionsList.addEventListener("click",function(e){e.stopPropagation()});var levelList=document.querySelector(".level-list"),levelsElem=document.querySelector(".levels"),levels=[];!function(){for(var e=levelsElem.querySelectorAll("pre"),t=document.createDocumentFragment(),n=0;n<e.length;n++){var i=e[n],o=document.createElement("li");o.className="level-list__item";var r=i.id;o.innerHTML='<span class="level-list__item__number">'+(n+1)+'</span> <span class="level-list__item__blurb">'+i.getAttribute("data-blurb")+'</span><span class="level-list__item__check">✔</span>',o.setAttribute("data-id",r),t.appendChild(o),levels.push(r)}levelList.appendChild(t),levelList.addEventListener("click",function(e){e.stopPropagation()});var a=document.createElement("i");a.className="fa fa-times close-button",levelList.appendChild(a)}();var instructionsButton=document.querySelector(".instructions-button");instructionsButton.addEventListener("click",function(e){e.stopPropagation(),instructionsList.classList.add("is-open"),levelList.classList.remove("is-open")});for(var closeButton=document.querySelectorAll(".close-button"),i=0;i<closeButton.length;i++)closeButton[i].addEventListener("click",function(){this.parentElement.classList.remove("is-open")});document.addEventListener("click",function(){instructionsList.classList.contains("is-open")?instructionsList.classList.remove("is-open"):levelList.classList.contains("is-open")&&levelList.classList.remove("is-open")});var levelSelectButton=document.querySelector(".level-select-button"),nextLevelButton=document.querySelector(".next-level-button");levelSelectButton.addEventListener("click",function(e){e.stopPropagation(),levelList.classList.add("is-open"),instructionsList.classList.remove("is-open")}),nextLevelButton.style.top=canvas.offsetTop+"px",levelList.addEventListener("click",function(e){var t=getParent(e.target,".level-list__item");if(t){var n=t.getAttribute("data-id");loadLevel(n)}});var initialLevel=localStorage.getItem("currentLevel")||levels[0];loadLevel(initialLevel),unipointer.bindStartEvent(canvas),window.addEventListener("mousemove",onHoverMousemove),animate();var canvasLeft=canvas.offsetLeft,canvasTop=canvas.offsetTop,pointerBehavior,cubDrag={},mazeRotate={};unipointer.pointerDown=function(e,t){e.preventDefault();var n=getIsInsideCub(t);pointerBehavior=n?cubDrag:mazeRotate,pointerBehavior.pointerDown(e,t),this._bindPostStartEvents(e)},unipointer.pointerMove=function(e,t){pointerBehavior.pointerMove(e,t)},unipointer.pointerUp=function(e,t){pointerBehavior.pointerUp(e,t),this._unbindPostStartEvents()};var dragStartPosition,dragStartPegPosition,rotatePointer;cubDrag.pointerDown=function(e,t){var n=getCubConnections();n&&n.length&&(isCubDragging=!0,dragStartPosition={x:t.pageX,y:t.pageY},dragStartPegPosition={x:cub[maze.orientation].x*gridSize+mazeCenter.x,y:cub[maze.orientation].y*gridSize+mazeCenter.y},docElem.classList.add("is-cub-dragging"))},cubDrag.pointerMove=function(e,t){isCubDragging&&(cubDragMove={x:t.pageX-dragStartPosition.x,y:t.pageY-dragStartPosition.y})},cubDrag.pointerUp=function(){cubDragMove=null,docElem.classList.remove("is-cub-dragging"),isCubDragging=!1,cub.setOffset({x:0,y:0},maze.orientation),cub.peg.x==maze.goalPosition.x&&cub.peg.y==maze.goalPosition.y&&(completeLevel(),console.log("win"))};var dragStartAngle,dragStartMazeAngle,moveAngle,mazeRotate={};mazeRotate.pointerDown=function(e,t){dragStartAngle=moveAngle=getDragAngle(t),dragStartMazeAngle=maze.flyWheel.angle,dragAngle=dragStartMazeAngle,rotatePointer=t},mazeRotate.pointerMove=function(e,t){rotatePointer=t,moveAngle=getDragAngle(t);var n=moveAngle-dragStartAngle;dragAngle=normalizeAngle(dragStartMazeAngle+n)},mazeRotate.pointerUp=function(){dragAngle=null,rotatePointer=null};var completedLevels=localStorage.getItem("completedLevels");completedLevels=completedLevels?completedLevels.split(","):[],completedLevels.forEach(function(e){var t=levelList.querySelector('[data-id="'+e+'"]');t&&t.classList.add("did-complete")}),nextLevelButton.addEventListener("click",function(){var e=getNextLevel();e&&loadLevel(e)});